/**
 * jQuery Equinox v1.0.0
 * Copyright 2014 Jordan Crown
 * Contributing Author: Cameron Rahman
 */
!function(t){var e={events:[],onEventClick:null,onPreviousMonthStart:null,onNextMonthStart:null,onCurrentMonthStart:null,onRefreshStart:null,onRefreshEnd:null},n={start:null,end:null,title:"",url:"","class":"",data:{}},a={init:function(a){return this.each(function(){var s=t(this),o=s.data("equinox");if(!o){for(var r=t.extend({},e,a),i=moment(),v=[],f=0;f<r.events.length;f++)r.events[f]=t.extend({},n,r.events[f]),r.events[f].start=moment(r.events[f].start),r.events[f].end=moment(r.events[f].end),r.events[f].start.isValid()&&r.events[f].end.isValid()&&(r.events[f].start.valueOf()>r.events[f].end.valueOf()||(r.events[f].allDay=d(r.events[f].start,r.events[f].end),r.events[f].daySpan=l(r.events[f].start,r.events[f].end),v.push(r.events[f])));r.events.sort(function(t,e){return t.start.valueOf()-e.start.valueOf()});for(var u=[],f=0;f<r.events.length;f++){r.events[f].id=f;var c=moment(r.events[f].start).startOf("day").format("UX");c in u||(u[c]=[]),u[c].push(r.events[f])}o={target:s,settings:r,currentDate:i,segmentedEvents:u,activeMonth:moment(i).startOf("month")},s.data("equinox",o),s.addClass("equinox"),s.equinox("refresh"),s.on("click",".calendar-actions button.prev",function(t){var e=s.data("equinox");e.activeMonth.subtract(1,"months"),typeof e.settings.onPreviousMonthStart==typeof Function&&e.settings.onPreviousMonthStart(t,e),s.equinox("refresh")}),s.on("click",".calendar-actions button.next",function(t){var e=s.data("equinox");e.activeMonth.add(1,"months"),typeof e.settings.onNextMonthStart==typeof Function&&e.settings.onNextMonthStart(t,e),s.equinox("refresh")}),s.on("click",".calendar-actions button.today",function(t){var e=s.data("equinox"),n=moment().startOf("month");typeof e.settings.onCurrentMonthStart==typeof Function&&e.settings.onCurrentMonthStart(t,e),0!==e.activeMonth.startOf("month").diff(n)&&(e.activeMonth=n,s.equinox("refresh"))}),s.on("click","a.event",function(e){var n=s.data("equinox");if(typeof n.settings.onEventClick==typeof Function){var a=n.settings.events[t(this).data("event-id")],o=t.extend({start:a.start,end:a.end,title:a.title,url:a.url,"class":a.class},a.data);n.settings.onEventClick(e,o)}})}})},refresh:function(){return this.each(function(){var e=t(this),n=e.data("equinox");typeof n.settings.onRefreshStart==typeof Function&&n.settings.onRefreshStart(n);var a=n.activeMonth,o=s(a,n.segmentedEvents);typeof n.settings.onRefreshEnd==typeof Function&&n.settings.onRefreshEnd(n),e.html(o)})}};t.fn.equinox=function(e){return a[e]?a[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void t.error("Method "+e+" does not exist on jQuery.equinox"):a.init.apply(this,arguments)};var s=function(e,n){var a=t('<div class="calendar"></div>'),s=t('<div class="calendar-header"></div>');s.append('<div class="month-label">'+e.format("MMMM YYYY")+"</div>"),s.append('<div class="calendar-actions"></div>'),t(".calendar-actions",s).append('<button type="button" class="prev">Previous</button> '),t(".calendar-actions",s).append('<button type="button" class="next">Next</button> '),t(".calendar-actions",s).append('<button type="button" class="today">Today</button> '),a.append(s);for(var d=t('<div class="month-weeks"></div>'),v=t('<div class="week week-header"><div class="days-container"></div></div>'),f=0;7>f;f++)t(".days-container",v).append('<div class="day '+moment().day(f).format("dddd").toLowerCase()+'">'+moment().day(f).format("dddd")+"</div>");d.append(v);var u=moment(e).startOf("month").startOf("week"),c=[];for(var f in n){if(parseInt(f.substr(1))>=u.unix())break;for(var p=0;p<n[f].length;p++)n[f][p].end.valueOf()>u.valueOf()&&(n[f][p].daysLeft=l(u,n[f][p].end)-(i(n[f][p].end)?1:0),c.push(n[f][p]))}var h=!1,m=e.daysInMonth(),y=moment();for(f=0;!h;f++){for(var g=t('<div class="week week-'+f+'"></div>'),M=[[]],x=moment(u),p=0;7>p;p++){if(x.day(p),0===p)for(var S=0;S<c.length;S++){for(var b=0;M[b][p];)b++,b in M||(M[b]=[]);M[b][p]=c[S];for(var O=p+1;O<c[S].daysLeft+p&&7>O;O++)M[b][O]="reserved"}for(var k=(x.format("UX")in n?n[x.format("UX")]:[]),S=0;S<k.length;S++)if(!(k[S].daySpan<2)){for(var b=0;M[b][p];)b++,b in M||(M[b]=[]);k[S].daysLeft=k[S].daySpan-(i(k[S].end)?1:0),M[b][p]=k[S];for(var O=p+1;O<k[S].daysLeft+p&&7>O;O++)M[b][O]="reserved"}}c=[],g.append('<ul class="week-events"></ul>');for(var p=0;p<M.length;p++){for(var b=t('<li class="slot"><ul></ul></li>'),S=0;7>S;S++)if("reserved"!==M[p][S])if(M[p][S]){var q=t('<li class="event-container span-'+Math.min(M[p][S].daysLeft,7-S)+'"></li>');M[p][S].daySpan-(i(M[p][S].end)?1:0)>M[p][S].daysLeft&&q.addClass("continuation"),M[p][S].daysLeft>7-S&&q.addClass("continued"),q.append(r(M[p][S])),t("ul",b).append(q),M[p][S].daysLeft>7-S?(M[p][S].daysLeft-=7-S,c.push(M[p][S])):delete M[p][S].daysLeft}else t("ul",b).append('<li class="event-container"></li>');t(".week-events",g).append(b)}g.append('<div class="days-container"></div>');for(var p=0;7>p;p++){u.day(p);for(var L=[],S=0;S<M.length;S++)M[S][p]&&L.push(S);var k=u.format("UX")in n?n[u.format("UX")]:[];t(".days-container",g).append(o(u,k,L,e,y)),u.month()===e.month()&&u.date()===m&&(h=!0)}d.append(g),u.add("days",1)}return a.append(d),a},o=function(e,n,a,s,o){var d=["date","date-"+e.date(),"day",moment(e).format("dddd").toLowerCase()];e.month()!==s.month()&&d.push("outside-month"),moment(e).startOf("day").valueOf()===moment(o).startOf("day").valueOf()&&d.push("current-date");var i=t('<div class="'+d.join(" ")+'"></div>');i.append('<div class="date-label">'+(1===e.date()?e.format("MMM "):"")+e.date()+"</div>"),i.append('<ul class="date-events"></ul>');for(var l=0,v=a.shift(),f=0;f<n.length;f++){if(l===v)t(".date-events",i).append('<li class="event-container placeholder"></li>'),v=a.shift(),f--;else{if(n[f].daySpan>2)continue;var u=t('<li class="event-container"></li>');u.append(r(n[f])),t(".date-events",i).append(u)}l++}return i},r=function(e){var n=t('<a class="event '+e.class+'" href="'+e.url+'"></a>');return n.data("event-id",e.id),n.append('<span class="start-time">'+e.start.format(0===e.start.minutes()?"ha":"h:mma")+"</span>"),n.append('<span class="title">'+e.title+"</span>"),n},d=function(t,e){return e.diff(t)%moment.duration(1,"days").asMilliseconds()===0},i=function(t){return"00:00:00.000"===t.format("HH:mm:ss.SSS")},l=function(t,e){var n=moment(t).startOf("day"),a=moment(e).startOf("day");return a.diff(n)/moment.duration(1,"days").asMilliseconds()+1}}(jQuery);